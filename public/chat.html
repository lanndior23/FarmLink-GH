<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FarmLink GH â€“ Chat</title>
  <link rel="stylesheet" href="css/style.css"/>
  <link rel="icon" href="assets/icon.ico"/>
  <style>
    body {
      background: #f0f8ff;
      font-family: Arial, sans-serif;
    }

    .chat-container {
      max-width: 700px;
      margin: 40px auto;
      background: #fff;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .chat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .messages {
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 10px;
      background: #f9f9f9;
    }

    .message {
      margin: 10px 0;
      padding: 8px 12px;
      border-radius: 6px;
      max-width: 75%;
    }

    .sent {
      background: #daf1ff;
      align-self: flex-end;
      margin-left: auto;
    }

    .received {
      background: #eee;
      align-self: flex-start;
    }

    .chat-form {
      margin-top: 15px;
      display: flex;
    }

    .chat-form input {
      flex: 1;
      padding: 10px;
      border-radius: 6px 0 0 6px;
      border: 1px solid #ccc;
    }

    .chat-form button {
      background: #28a745;
      color: #fff;
      padding: 10px 20px;
      border: none;
      border-radius: 0 6px 6px 0;
      cursor: pointer;
    }

    .label {
      font-weight: bold;
      color: #0077cc;
    }

    .delete-button {
      margin-left: 10px;
      background: #dc3545;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      padding: 5px 10px;
    }
  </style>
</head>
<body>
  <div class="chat-container">
    <div class="chat-header">
      <h2>FarmLink Chat</h2>
      <span id="receiverName" class="label"></span>
    </div>

    <div class="messages" id="chatBox"></div>

    <form class="chat-form" id="chatForm">
      <input type="text" id="chatInput" placeholder="Type your message..." required />
      <button type="submit">Send</button>
    </form>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
  <script src="firebase/config.js"></script>
  <script>
    const auth = firebase.auth();
    const db = firebase.firestore();

    const chatBox = document.getElementById("chatBox");
    const chatForm = document.getElementById("chatForm");
    const chatInput = document.getElementById("chatInput");
    const receiverName = document.getElementById("receiverName");

    const urlParams = new URLSearchParams(window.location.search);
    const to = urlParams.get("to"); // recipient UID

    if (!to) {
      alert("No chat user specified.");
      window.location.href = "buyer_dashboard.html";
      return; // Stop further script execution if no user specified
    }

    auth.onAuthStateChanged(async user => {
      if (!user) {
        return window.location.href = "login.html";
      }

      const from = user.uid;

      // Show receiver label
      const userDoc = await db.collection("users").doc(to).get();
      const userData = userDoc.data();
      receiverName.textContent = `Chatting with: ${userData.fullName || 'User'}`;

      // Ensure participants array is always sorted for consistency
      const participants = [from, to].sort((a, b) => a.localeCompare(b));

      // Fetch & display messages between the two users only
      db.collection("messages")
        .where("participants", "array-contains", from)
        .orderBy("timestamp")
        .onSnapshot(snapshot => {
          chatBox.innerHTML = "";
          let found = false;
          snapshot.forEach(doc => {
            const msg = doc.data();
            // Only show messages where participants contain both from and to
            if (
              Array.isArray(msg.participants) &&
              msg.participants.includes(from) &&
              msg.participants.includes(to)
            ) {
              found = true;
              const msgDiv = document.createElement("div");
              msgDiv.classList.add("message");
              msgDiv.classList.add(msg.from === from ? "sent" : "received");
              msgDiv.textContent = msg.text;

              // Add delete button for sender's messages
              if (msg.from === from) {
                const delBtn = document.createElement("button");
                delBtn.textContent = "Delete";
                delBtn.classList.add("delete-button");
                delBtn.onclick = async () => {
                  if (confirm("Delete this message?")) {
                    await db.collection("messages").doc(doc.id).delete();
                  }
                };
                msgDiv.appendChild(delBtn);
              }

              chatBox.appendChild(msgDiv);
            }
          });

          if (!found) {
            chatBox.innerHTML = "<div style='color:#888;text-align:center;'>No messages yet or failed to fetch.</div>";
          }

          chatBox.scrollTop = chatBox.scrollHeight;
        });

      // Send message
      chatForm.addEventListener("submit", async e => {
        e.preventDefault();

        const message = chatInput.value.trim();
        if (message === "") return;

        // Always store participants as a sorted array (by UID)
        const sortedParticipants = [from, to].sort((a, b) => a.localeCompare(b));
        await db.collection("messages").add({
          from: from,
          to: to,
          text: message,
          participants: sortedParticipants,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => {
          chatInput.value = "";
        }).catch(err => {
          alert("Failed to send message: " + err.message);
        });

        localStorage.setItem("lastSeenMessageId", Date.now().toString());
      });
    });
  </script>
</body>
</html>
</html>
  </script>
</body>
</html>
</html>
